from database import engine, create_db_and_tables
from sqlmodel import Session, select
from models import User, Offer, Order, UserRole
from auth import hash_password

def ensure_user(session: Session, email: str, password: str, role: UserRole) -> User:
    u = session.exec(select(User).where(User.email == email)).first()
    if u:
        return u
    u = User(email=email, password_hash=hash_password(password[:72]), role=role)
    session.add(u)
    session.commit()
    session.refresh(u)
    return u

def ensure_offer(session: Session, **kwargs) -> Offer:
    o = Offer(**kwargs)
    session.add(o)
    session.commit()
    session.refresh(o)
    return o

def run():
    create_db_and_tables()
    with Session(engine) as s:
        producer = ensure_user(s, "producer@example.com", "Passw0rd!", UserRole.PRODUCER)
        buyer = ensure_user(s, "buyer@example.com", "Passw0rd!", UserRole.BUYER)

        if not s.exec(select(Offer)).first():
            o1 = ensure_offer(
                s,
                producer_id=producer.id,
                product_name="Pellet sosnowy A1",
                product_category="Fuel",
                sku="PEL-A1-25KG",
                description="Pellet 6mm, worki 25kg",
                quantity=1000,
                unit_of_measure="kg",
                unit_price=1.20,
                currency="PLN",
                location="Kraków",
                active=True,
            )
            o2 = ensure_offer(
                s,
                producer_id=producer.id,
                product_name="Stal pręt 12mm",
                product_category="Steel",
                sku=None,
                description="Pręty zbrojeniowe",
                quantity=500,
                unit_of_measure="pcs",
                unit_price=9.99,
                currency="PLN",
                location="Katowice",
                active=True,
            )

            # one sample order
            ord1 = Order(buyer_id=buyer.id, offer_id=o1.id, quantity=50, unit_price_snapshot=o1.unit_price)
            s.add(ord1)
            s.commit()
    print("Seed done.\nLogins:\n  producer@example.com / Passw0rd!\n  buyer@example.com    / Passw0rd!")

if __name__ == "__main__":
    run()
